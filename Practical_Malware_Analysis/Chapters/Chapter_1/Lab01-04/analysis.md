### Lab1-4

Analyze the file Lab01-04.exe.

Questions:

**1]** Upload the Lab01-04.exe file to http://www.VirusTotal.com/. Does it match
any existing antivirus definitions?
**Solution** : At the time of writing this solution, 

* 54/68 AVs detected the file as malicious.
* Many AVs classified it as a Downloader.

**2]** Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.
**Solution** :
No signs of obfuscation. 

* Analysis of strings suggest that there is no obfuscation as there are plenty of imports, the strings are all clear and understandable.
* PEiD also indicated that there is no obfuscation.

**3]** When was this program compiled?
**Solution** : 
The timestamp in the executable says it was compiled on 2019-08-30 22:26:59. That is 30th August, 2019.  Which is definitely fake. (This is what I was taking about while analyzing the compile time of Lab01-01.exe)

**4]** Do any imports hint at this programâ€™s functionality? If so, which imports are they and what do they tell you?
**Solution** : 

* Imports from **KERNEL32.dll** :
	* There are **Resouce** finding and manipulating functions like **FindResource**, **LoadResource**, **SizeofResource** . So, it can be concluded that the executable searches for some kind of resource and loads it.
	* There are **File Handling** functions like **CreateFile**, **WriteFile**, **MoveFile**. It can be said that a new file is created and something is written into that file.
	* **WinExec** : This function is used to execute a new process. So, it seems a new process is executed. 
	* **CreateRemoteThread** : This function is used to create a thread that runs in the virtual space of another process. It is commonly used to **inject** a thread into a process.
	

**5]** What host- or network-based indicators could be used to identify this malware on infected machines?
**Solution** : 

* There are very interesting strings in the executable: 
	* **\system32\wupdmgr.exe**: The Windows Update Manager which gives all those auto-updates. This probably is modified or it is run and a malicious thread is injected. This Update Manager can be a host-based signature.
	* **winup.exe** : winup mostly stands for Windows Update. This file may be created because there exists no file of this name in the system. This new Update program also should be a part of the host-based signature.
	* **http://www.pracitcalmalwareanalysis.com/updater.exe** : There is high probability that this updater.exe is downloaded and downloads more malware in the name of system updates. This URL can be used as a network indicator.

**6]** This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource.
What can you learn from the resource?

**Solution** : The .rsrc section consists of another PE image. Looking at the strings and functions imported, this downloads the updater.exe from that URL given.

* It has imported WinExec. So, it can be safely concluded that it executes the updater.exe.
* But, updater.exe will not be updater.exe. It is downloaded and written into the file named winup.exe which was created by the Lab01-04.exe.

**Detailed Analysis** :
**Lab01-04.exe**

1. Output of VirusTotal.com:
	* 54/68 AVs detected it to be malicious and many of them classified it as a Downloader.
2. Imports from **KERNEL32.dll** :
	*	CloseHandle
	*	OpenProcess
	*	GetCurrentProcess
	*	CreateRemoteThread
	*	GetProcAddress
	*	LoadLibraryA
	*	WinExec
	*	WriteFile
	*	CreateFileA
	*	SizeofResource
	*	LoadResource
	*	FindResourceA
	*	GetModuleHandleA
	*	GetWindowsDirectoryA
	*	MoveFileA
	*	GetTempPathA
3. Imports from **ADVAPI32.dll** :
	*	AdjustTokenPrivileges
	*	LookupPrivilegeValueA
	*	OpenProcessToken
4. String present in the image :
	*	\system32\wupdmgr.exe
	*	\winup.exe
	*	winlogon.exe
	*	< not real>
	*	and many more. But I felt these help in finding what the malware is.

**Image Embedded in .rsrc section**

1. Imports from **KERNEL32.dll** :
	*	GetWindowsDirectoryA
	*	WinExec
	*	GetTempPathA

2. Import from **urlmon.dll** :
	* URLDownloadToFIle

3. Strings in this executable:  
	* \winup.exe
	*  \system32\wupdmgrd.exe
	* http://www.practicalmalwareanalysis.com/updater.exe


**Connecting the Dots and Hypothesis** 

1. Suppose the Lab01-04.exe is run. based on the evidences we have so far, it can be concluded that the embedded executable will be written onto the disk(File functions like **CreateFile**, **WriteFile**). 
2. There is a reference to the **\system32\wupdmgr.exe**. So, This program is modified and the embedded executable is added or it is run and the embedded executable is injected as a thread into that wupdmgr.exe, or as there is CreateFile used, a new file named wupdmgr.exe is created in the system32 folder (which overwrites the older, legitimate update program)and the embedded executable is written to it. So, the system regularly executes it thinking it is the legitimate Update program but it is not. It is the malicious one.

3. Looking at the imports from ADVAPI32.dll, important system files' privileges are being checked(**LookupPrivilegeValue**) and being modified (**AdjustTokenPrivileges**). One of those files could mostly be the \system32\wupdmgr.exe. The other I am thinking is the **winup.exe**.
4. So, in some manner, the embedded executable is inside the system(say, it runs when wupdmgr.exe is run). 
5. The embedded image has an interesting URL - 			**http://www.practicalmalwareanalysis.com/updated.exe**  . Also, it has imported the function **URLDownloadToFile**.So, this **updater.exe** is downloaded when the embedded image is run and it is stored into a file. To make it look like a legitimate system program, it might be stored in **winup.exe**. As it also uses the **WinExec** function, it suggests that the embedded executable runs the winup.exe program. 
6.  So, whenever the wupdmgr.exe is run by the system, the embedded executable is also run, which in turn *a*. possibly download a new updater.exe into winup.exe and runs it or *b*. executes the present malicious **winup.exe** program.

PS: I checked out more about **winup.exe** program. It is not a system file and is a file created by malware. **winup.exe** is the common name of such downloaded malicious programs. It was found in a system which was affected by a **worm**, which got connected to a Remote Server whenever Internet is on and downloaded.
Check this out: https://www.file.net/process/winup.exe.html

Out of the 4 samples, this was the most exciting one to analyze because it used many cool features and mechanisms to work as a Downloader. 
